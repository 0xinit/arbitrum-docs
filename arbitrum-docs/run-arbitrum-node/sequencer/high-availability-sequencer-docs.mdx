import ImageZoom from '@site/src/components/ImageZoom';

# How to set up a high availability sequencer for your Arbitrum chain

:::caution

This documentation is intended for production sequencer deployments. If you want to set up a sequencer for testing or on a testnet, please refer to [How to run a testnet sequencer node].

:::

## Introduction

The sequencer is a critical component of your Arbitrum chain and is responsible for queuing transactions submitted to the network. It serves as the transaction ordering engine, accepting transactions forwarded from full nodes, queuing them, and returning feed messages to those full nodes. It subsequently sends queued transactions to batch posters for data posting.

If your sequencer goes offline, the network will be unable to process new transactions arriving at the child chain's RPC nodes, which will impact user experience. This guide provides detailed instructions for setting up a high availability (HA) sequencer architecture to minimize downtime and ensure your Arbitrum chain remains operational even if individual components fail.

## Prerequisites

Before you begin, ensure you have:

- Experience with Kubernetes and container orchestration
- Access to a Kubernetes cluster with multiple availability zones
- Understanding of Redis and cloud infrastructure
- A properly configured parent chain node or RPC node endpoint
- Sequencer keys and permissions
- Sufficient storage and compute resources

## High availability sequencer architecture

A high availability sequencer deployment consists of seven key components:

1. **CDN/Load Balancer** - Manages traffic routing and bot detection
2. **Nitro Fullnodes** - Process read requests and forward write transactions
3. **External Relays** - Handle public feed traffic
4. **Sequencer Relays** - Combine feeds from all sequencers
5. **Sequencers** - Multiple redundant transaction queueing machines
6. **Redis** - Coordinates active sequencer selection and sequencer-related information sharing
7. **Batch Poster** - Posts transaction batches to the parent chain

### Architecture diagrams

The architecture varies slightly depending on whether your full nodes use Redis to identify the active sequencer or forward transactions to a predefined endpoint.

#### Send to active enabled

In this configuration, full nodes query Redis to determine the active sequencer and forward transactions directly to it:

<ImageZoom
  src="/img/ha-sequencer-sendto-active.svg"
  alt="send to active enable"
  className="img-600px"
/>

#### Send to active disabled

In this configuration, full nodes forward transactions to a predefined endpoint without checking which sequencer is active:

<ImageZoom
  src="/img/ha-sequencer-send-to-nonactive.svg"
  alt="send to active disable"
  className="img-600px"
/>

## Using Helm Charts for Deployment

We strongly recommend using the [Offchain Labs Community Helm Charts](https://github.com/OffchainLabs/community-helm-charts) for deploying your high availability sequencer setup. These charts provide pre-configured templates for all the necessary components and make it easier to maintain your deployment.

### Adding the Helm Repository

```console
helm repo add offchainlabs https://charts.arbitrum.io
helm repo update
```

## Detailed component setup

### 1. Load balancing (CDN)

We strongly recommend using a CDN for managing traffic and security concerns:

- **Recommendation**: Use Cloudflare or a similar CDN service
- **Configuration**:
  - Direct `/rpc` traffic to the Nitro full node fleet
  - Direct `/feed` traffic to public-facing relays
  - Implement rate limiting and bot detection as needed
- **Benefits**: Distributes load, improves security, and enhances availability

### 2. Relays setup

The requirement is for two types of relays in the architecture:

#### Sequencer relays

Deploy sequencer relays using the relay helm chart:

```console
helm install sequencer-relay offchainlabs/relay \
  --set replicaCount=3 \
  --set configmap.data.chain.id=<your-chain-id> \
  --set configmap.data.node.feed.input.url=ws://sequencer-nitro-0.sequencer-nitro:9642,ws://sequencer-nitro-1.sequencer-nitro:9642,ws://sequencer-nitro-2.sequencer-nitro:9642
```

Key configuration parameters:
- `replicaCount`: Number of relay replicas to deploy (recommend at least 3 for high availability)
- `configmap.data.chain.id`: Your chain ID
- `configmap.data.node.feed.input.url`: Comma-separated list of WebSocket URLs for all sequencer feed outputs

#### External relays

Deploy external relays that connect to the sequencer relays:

```console
helm install external-relay offchainlabs/relay \
  --set replicaCount=3 \
  --set configmap.data.chain.id=<your-chain-id> \
  --set configmap.data.node.feed.input.url=ws://sequencer-relay:9642
```

For more details on relay configuration, see [run a feed relay](/run-arbitrum-node/sequencer/run-feed-relay).

### 3. Nitro full nodes setup

Deploy a set of Nitro full nodes to handle read requests and forward write transactions:

```console
helm install fullnode offchainlabs/nitro \
  --set replicaCount=3 \
  --set configmap.data.parent-chain.id=<parent-chain-id> \
  --set configmap.data.parent-chain.connection.url=<parent-node-url> \
  --set configmap.data.chain.id=<child-chain-id> \
  --set configmap.data.execution.forwarding-target=http://sequencer-nitro:8547
```

#### Send to active configuration (optional)

To enable Redis-based active sequencer discovery:

```console
helm install fullnode offchainlabs/nitro \
  --set replicaCount=3 \
  --set configmap.data.parent-chain.id=<parent-chain-id> \
  --set configmap.data.parent-chain.connection.url=<parent-node-url> \
  --set configmap.data.chain.id=<child-chain-id> \
  --set configmap.data.execution.sequencer.forwarder.redis-url=redis://<redis-url>:6379
```

#### Mutating-only endpoint (optional)

For nodes dedicated to transaction submission only, add this to your values.yaml:

```yaml
configmap:
  data:
    execution:
      rpc:
        allow-method: ["eth_sendRawTransaction"]
```

For more details on full node configuration, see [run a full node](/run-arbitrum-node/03-run-full-node.mdx).

### 4. Redis setup

Set up a highly available Redis cluster for sequencer coordination:

- **Deployment options**:
  - Use a managed service like AWS ElastiCache (recommended)
  - Deploy within Kubernetes using a StatefulSet with PersistentVolumeClaims

- **Requirements**:
  - Minimum of three replicas across different availability zones (recommended)
  - Secured access (only accessible within the Kubernetes cluster)
  - Backups enabled

- **Configuration**:
  - Use a Redis cluster or Redis Sentinel for high-availability
  - Secure the endpoint with proper network policies
  - Monitor Redis health as part of your overall monitoring strategy

### 5. Sequencer setup

Deploy multiple sequencer replicas with availability zone spread using the nitro helm chart:

```console
helm install sequencer offchainlabs/nitro \
  --set replicaCount=3 \
  --set configmap.data.parent-chain.id=<parent-chain-id> \
  --set configmap.data.parent-chain.connection.url=<parent-node-url> \
  --set configmap.data.chain.id=<child-chain-id> \
  --set configmap.data.node.sequencer.enable=true \
  --set configmap.data.node.delayed-sequencer.enable=true \
  --set configmap.data.node.seq-coordinator.enable=true \
  --set configmap.data.node.seq-coordinator.redis-url=<redis-url> \
  --set configmap.data.node.seq-coordinator.lockout-duration=30s \
  --set configmap.data.node.seq-coordinator.lockout-spare=1s \
  --set configmap.data.node.seq-coordinator.retry-interval=0.5s \
  --set configmap.data.node.seq-coordinator.seq-num-duration=24h0m0s \
  --set configmap.data.node.feed.output.enable=true \
  --set configmap.data.node.feed.output.port=9642 \
  --set configmap.data.node.batch-poster.enable=false \
  --set configmap.data.execution.sequencer.enable=true \
  --set configmap.data.execution.sequencer.max-tx-data-size=85000 \
  --set configmap.data.execution.sequencer.max-block-speed=250ms
```

#### Critical sequencer coordinator parameters

The sequencer coordinator is the key component for high availability. These parameters are essential:

| Parameter | Description | Recommended Value |
|-----------|-------------|------------------|
| `node.seq-coordinator.enable` | Enable sequencer coordinator | `true` |
| `node.seq-coordinator.redis-url` | Redis URL for coordination | Your Redis URL |
| `node.seq-coordinator.lockout-duration` | How long a sequencer holds the active role | `30s` |
| `node.seq-coordinator.lockout-spare` | Buffer time before lockout expires | `1s` |
| `node.seq-coordinator.my-url` | URL for this sequencer | Unique per sequencer |
| `node.seq-coordinator.retry-interval` | Time between retries | `0.5s` |
| `node.seq-coordinator.seq-num-duration` | How long to keep sequence numbers | `24h0m0s` |

#### Individual sequencer services

For each sequencer replica, create a headless service to allow direct access:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: sequencer-nitro-0
spec:
  ports:
    - name: rpc
      port: 8547
      protocol: TCP
      targetPort: 8547
    - name: ws
      port: 8548
      protocol: TCP
      targetPort: 8548
    - name: feed
      port: 9642
      protocol: TCP
      targetPort: 9642
  selector:
    app.kubernetes.io/instance: sequencer
    app.kubernetes.io/name: nitro
    statefulset.kubernetes.io/pod-name: sequencer-nitro-0
  type: ClusterIP
```

Repeat for each sequencer replica, changing the name and selector accordingly.

### 6. Sequencer coordinator manager

To manage active sequencer selection, use the built-in sequencer coordinator UI:

- Follow detailed instructions at: [Running a Sequencer Coordinator Manager](https://docs.arbitrum.io/node-running/how-tos/running-a-sequencer-coordinator-manager)
- Use this interface to switch between sequencer replicas when needed manually
- Configure permissions and access controls appropriately

### 7. Batchposter setup

Deploy the batch poster using the nitro helm chart:

```console
helm install batchposter offchainlabs/nitro \
  --set configmap.data.parent-chain.id=<parent-chain-id> \
  --set configmap.data.parent-chain.connection.url=<parent-node-url> \
  --set configmap.data.chain.id=<child-chain-id> \
  --set configmap.data.execution.forwarding-target=null \
  --set configmap.data.node.seq-coordinator.enable=true \
  --set configmap.data.node.seq-coordinator.redis-url=<redis-url> \
  --set configmap.data.node.seq-coordinator.lockout-duration=30s \
  --set configmap.data.node.seq-coordinator.lockout-spare=1s \
  --set configmap.data.node.seq-coordinator.retry-interval=0.5s \
  --set configmap.data.node.seq-coordinator.seq-num-duration=24h0m0s \
  --set configmap.data.node.batch-poster.enable=true \
  --set "configmap.data.node.batch-poster.parent-chain-wallet.private-key=<your-private-key>"
```

Important: Do not add the batch poster to the sequencer priority list in the Sequencer Coordinator Manager (SQM) to prevent it from becoming the active sequencer.

## Monitoring and maintenance

### Health checks

Implement comprehensive health checks for all components:

- **Sequencer health**: Monitor the sequencer's logs and metrics
- **Redis connectivity**: Ensure all components can access Redis
- **Feed availability**: Verify feed connectivity between components
- **Transaction processing**: Monitor end-to-end transaction flow

### Troubleshooting

If you run into any issues, visit the [node-running troubleshooting guide](/run-arbitrum-node/06-troubleshooting.mdx).

## References

- [How to Run a Fullnode](https://docs.arbitrum.io/node-running/how-tos/running-a-node)
- [Running a Sequencer Coordinator Manager](https://docs.arbitrum.io/node-running/how-tos/running-a-sequencer-coordinator-manager)
- [Kubernetes Documentation](https://kubernetes.io/docs/)
- [Offchain Labs Community Helm Charts](https://github.com/OffchainLabs/community-helm-charts)
